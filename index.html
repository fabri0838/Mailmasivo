<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AV MERCH ‚Äî Email Masivo</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#05080f; --surface:#0c1020; --border:#1a2040;
  --blue:#4285F4; --blue2:#5b9cf6; --white:#e8eaf0;
  --muted:#4a5568; --accent:#a8d4ff; --danger:#ff5252;
  --yellow:#ffd54f; --green:#69f0ae;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--white);font-family:'Syne',sans-serif;min-height:100vh;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 50% -10%,rgba(66,133,244,0.12),transparent);pointer-events:none;z-index:0;}
.container{max-width:920px;margin:0 auto;padding:40px 24px;position:relative;z-index:1;}
header{margin-bottom:40px;}
.logo-row{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
.logo{background:var(--blue);color:#fff;font-weight:800;font-size:12px;padding:5px 12px;letter-spacing:2px;}
.badge{background:#0d1530;border:1px solid var(--blue);color:var(--blue2);font-family:'DM Mono',monospace;font-size:11px;padding:4px 10px;}
h1{font-size:clamp(26px,5vw,44px);font-weight:800;letter-spacing:-1.5px;line-height:1;}
h1 span{color:var(--blue2);}
.subtitle{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);margin-top:6px;letter-spacing:1px;}
.notice{background:#0a0f20;border:1px solid #1a2a50;border-left:3px solid var(--yellow);padding:12px 16px;font-family:'DM Mono',monospace;font-size:11px;color:#b0b8c8;margin-bottom:14px;line-height:1.7;}
.notice strong{color:var(--yellow);}
.auth-banner{background:var(--surface);border:1px solid var(--border);padding:20px 24px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;}
.auth-info{display:flex;align-items:center;gap:12px;}
.auth-dot{width:8px;height:8px;border-radius:50%;background:var(--muted);flex-shrink:0;transition:all 0.3s;}
.auth-dot.on{background:var(--green);box-shadow:0 0 8px var(--green);}
.auth-text strong{display:block;font-family:'DM Mono',monospace;font-size:12px;}
.auth-text span{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);}
.mode-bar{display:flex;margin-bottom:14px;background:var(--surface);border:1px solid var(--border);overflow:hidden;}
.mode-btn{flex:1;padding:12px;font-family:'DM Mono',monospace;font-size:11px;letter-spacing:1px;background:transparent;border:none;color:var(--muted);cursor:pointer;transition:all 0.15s;text-align:center;}
.mode-btn.on{background:var(--blue);color:#fff;}
.mode-btn:not(.on):hover{background:#0d1530;color:var(--white);}
.stats-bar{display:flex;align-items:center;background:var(--surface);border:1px solid var(--border);margin-bottom:14px;}
.stat{padding:16px 20px;border-right:1px solid var(--border);text-align:center;}
.stat-num{font-size:28px;font-weight:800;color:var(--accent);line-height:1;}
.stat-label{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:1px;margin-top:2px;}
.pw{flex:1;padding:16px 24px;}
.pl{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);margin-bottom:8px;display:flex;justify-content:space-between;}
.pb{background:#0d1530;height:6px;}
.pf{height:100%;background:var(--blue);transition:width 0.5s ease;width:0%;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px;}
@media(max-width:640px){.grid{grid-template-columns:1fr;}}
.panel{background:var(--surface);border:1px solid var(--border);padding:22px;position:relative;}
.panel::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:var(--blue);}
.panel-label{font-family:'DM Mono',monospace;font-size:10px;color:var(--blue2);letter-spacing:2px;text-transform:uppercase;margin-bottom:12px;}
.fl{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:1px;margin-bottom:6px;margin-top:12px;}
.fl:first-of-type{margin-top:0;}
textarea,input[type=text]{width:100%;background:#070d1e;border:1px solid var(--border);color:var(--white);font-family:'DM Mono',monospace;font-size:13px;padding:12px;outline:none;transition:border-color 0.2s;line-height:1.6;}
textarea{resize:vertical;min-height:110px;}
textarea:focus,input:focus{border-color:var(--blue);}
.hint{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);margin-top:8px;line-height:1.7;}
.hint strong{color:var(--accent);}
.delay-bar{background:var(--surface);border:1px solid var(--border);padding:14px 22px;margin-bottom:14px;display:flex;align-items:center;gap:16px;flex-wrap:wrap;}
.delay-label{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);flex-shrink:0;}
.delay-opts{display:flex;gap:8px;flex-wrap:wrap;}
.db{font-family:'DM Mono',monospace;font-size:11px;padding:5px 12px;background:transparent;border:1px solid var(--border);color:var(--muted);cursor:pointer;transition:all 0.15s;}
.db.on{border-color:var(--blue);color:var(--blue2);background:#0d1530;}
.delay-warn{font-family:'DM Mono',monospace;font-size:10px;color:var(--yellow);margin-left:auto;}
.btn-row{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;}
.btn{display:inline-flex;align-items:center;gap:8px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;padding:12px 22px;cursor:pointer;border:none;letter-spacing:0.5px;transition:all 0.15s;text-decoration:none;}
.btn-blue{background:var(--blue);color:#fff;}
.btn-blue:hover{background:#5b9cf6;transform:translateY(-1px);}
.btn-blue:disabled{opacity:0.3;cursor:not-allowed;transform:none;}
.btn-grad{background:linear-gradient(135deg,var(--blue),#7c4dff);color:#fff;}
.btn-grad:hover{transform:translateY(-1px);filter:brightness(1.1);}
.btn-grad:disabled{opacity:0.3;cursor:not-allowed;transform:none;filter:none;}
.btn-out{background:transparent;border:1px solid var(--border);color:var(--muted);}
.btn-out:hover{border-color:var(--white);color:var(--white);}
.btn-red{background:transparent;border:1px solid var(--muted);color:var(--muted);}
.btn-red:hover{border-color:var(--danger);color:var(--danger);}
.btn-con{background:var(--blue);color:#fff;font-family:'Syne',sans-serif;font-weight:700;font-size:13px;padding:10px 20px;cursor:pointer;border:none;transition:all 0.15s;}
.btn-con:hover{background:#5b9cf6;}
.btn-dis{background:transparent;border:1px solid var(--danger);color:var(--danger);font-family:'Syne',sans-serif;font-weight:700;font-size:12px;padding:8px 14px;cursor:pointer;transition:all 0.15s;}
.btn-dis:hover{background:var(--danger);color:#fff;}
.empty-state{text-align:center;padding:50px 20px;border:1px dashed var(--border);margin-bottom:14px;}
.ei{font-size:44px;margin-bottom:14px;opacity:0.4;}
.et{font-size:18px;font-weight:700;color:var(--muted);margin-bottom:8px;}
.es{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);}
.card{background:var(--surface);border:1px solid var(--border);padding:24px;margin-bottom:14px;display:none;}
.card.on{display:block;}
.card-top{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap;margin-bottom:16px;}
.cn{font-size:20px;font-weight:800;}
.ce{font-family:'DM Mono',monospace;font-size:13px;color:var(--blue2);margin-top:3px;}
.ci{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);margin-top:4px;}
.tag{display:inline-block;background:#0d1530;color:var(--blue2);font-family:'DM Mono',monospace;font-size:10px;padding:3px 10px;letter-spacing:1px;border:1px solid var(--border);}
.preview{border:1px solid var(--border);overflow:hidden;}
.ph{background:#0d1530;padding:10px 14px;font-family:'DM Mono',monospace;font-size:11px;display:flex;gap:20px;flex-wrap:wrap;}
.pf2{color:var(--muted);}
.pf2 strong{color:var(--white);}
.pb2{padding:14px;font-family:'DM Mono',monospace;font-size:12px;line-height:1.8;color:#b0bcd0;white-space:pre-wrap;word-break:break-word;max-height:130px;overflow-y:auto;}
.card-btns{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap;}
.done-state{text-align:center;padding:50px 20px;background:var(--surface);border:1px solid var(--green);margin-bottom:14px;display:none;}
.done-icon{font-size:50px;margin-bottom:12px;}
.done-title{font-size:24px;font-weight:800;color:var(--green);margin-bottom:6px;}
.done-sub{font-family:'DM Mono',monospace;font-size:12px;color:var(--muted);}
.history-panel{background:var(--surface);border:1px solid var(--border);padding:22px;}
.history-list{max-height:200px;overflow-y:auto;}
.hi{display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid #0d1530;font-family:'DM Mono',monospace;font-size:11px;}
.hi:last-child{border-bottom:none;}
.hd{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.hd.sent{background:var(--blue2);}
.hd.skipped{background:var(--muted);}
.hd.error{background:var(--danger);}
.hn{color:var(--white);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.hem{color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px;}
.hs.sent{color:var(--green);}
.hs.skipped{color:var(--muted);}
.hs.error{color:var(--danger);}
.empty-history{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);text-align:center;padding:20px;}
.overlay{display:none;position:fixed;inset:0;background:rgba(5,8,15,0.9);align-items:center;justify-content:center;z-index:100;flex-direction:column;gap:16px;}
.overlay.on{display:flex;}
.spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.ot{font-family:'DM Mono',monospace;font-size:13px;color:var(--blue2);}
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:#070d1e;}
::-webkit-scrollbar-thumb{background:var(--border);}
</style>
</head>
<body>

<div class="overlay" id="overlay">
  <div class="spinner"></div>
  <div class="ot" id="overlayText">Enviando...</div>
</div>

<div class="container">
  <header>
    <div class="logo-row">
      <div class="logo">AV MERCH</div>
      <div class="badge">Gmail API</div>
    </div>
    <h1>Email <span>Masivo</span></h1>
    <div class="subtitle">// conect√° Gmail ‚Üí carg√° contactos ‚Üí envi√° autom√°tico con delay</div>
  </header>

  <div class="notice">
    <strong>‚ÑπÔ∏è L√≠mites gratuitos de Gmail:</strong> 500 emails/d√≠a con Gmail normal ¬∑ 2000/d√≠a con Google Workspace.
    Us√° delay entre env√≠os para evitar filtros de spam.
  </div>

  <div class="auth-banner">
    <div class="auth-info">
      <div class="auth-dot" id="authDot"></div>
      <div class="auth-text">
        <strong id="authLabel">No conectado a Gmail</strong>
        <span id="authSub">Autentic√° tu cuenta para enviar emails directamente</span>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <button class="btn-con" id="btnCon">Conectar Gmail</button>
      <button class="btn-dis" id="btnDis" style="display:none">Desconectar</button>
    </div>
  </div>

  <div class="mode-bar">
    <button class="mode-btn on" id="modeA">‚ö° AUTOM√ÅTICO (Gmail API)</button>
    <button class="mode-btn" id="modeM">‚úâÔ∏è MANUAL (mailto:)</button>
  </div>

  <div class="stats-bar">
    <div class="stat"><div class="stat-num" id="sTotal">0</div><div class="stat-label">TOTAL</div></div>
    <div class="stat"><div class="stat-num" id="sEnv" style="color:var(--green)">0</div><div class="stat-label">ENVIADOS</div></div>
    <div class="stat"><div class="stat-num" id="sOmi" style="color:var(--muted)">0</div><div class="stat-label">OMITIDOS</div></div>
    <div class="stat"><div class="stat-num" id="sErr" style="color:var(--danger)">0</div><div class="stat-label">ERRORES</div></div>
    <div class="pw">
      <div class="pl"><span>PROGRESO</span><span id="pPct">0%</span></div>
      <div class="pb"><div class="pf" id="pFill"></div></div>
    </div>
  </div>

  <div class="grid">
    <div class="panel">
      <div class="panel-label">// 01 ‚Äî Contactos</div>
      <textarea id="inContacts" placeholder="Empresa X, contacto arroba empresa.com&#10;Juan Perez, juan arroba gmail.com&#10;Maria Lopez, maria arroba empresa.com&#10;&#10;‚Äî un contacto por linea&#10;‚Äî formato: Nombre, email"></textarea>
      <div class="hint">
        ‚ú¶ Formato: <strong>Nombre, email</strong> ‚Äî un contacto por l√≠nea<br>
        ‚ú¶ Pod√©s pegar desde Excel directamente<br>
        ‚ú¶ Se ignoran l√≠neas con formato inv√°lido
      </div>
    </div>
    <div class="panel">
      <div class="panel-label">// 02 ‚Äî Asunto y Mensaje</div>
      <div class="fl">ASUNTO</div>
      <input type="text" id="inSubject" placeholder="Uniformes corporativos a medida ‚Äî AV MERCH">
      <div class="fl">CUERPO DEL EMAIL</div>
      <textarea id="inMessage" placeholder="Hola {nombre},&#10;&#10;Mi nombre es Fabrizio y te escribo de AV MERCH, empresa especializada en uniformes corporativos a medida.&#10;&#10;Me gustaria contarte sobre nuestras propuestas. Tenes disponibilidad para una breve charla?&#10;&#10;Saludos,&#10;Fabrizio&#10;AV MERCH"></textarea>
      <div class="hint">
        ‚ú¶ Us√° <strong>{nombre}</strong> para personalizar el saludo<br>
        ‚ú¶ Saltos de l√≠nea y formato se respetan
      </div>
    </div>
  </div>

  <div class="delay-bar" id="delayBar">
    <div class="delay-label">DELAY ENTRE ENV√çOS:</div>
    <div class="delay-opts">
      <button class="db" id="d0" onclick="setDelay(0)">Sin delay</button>
      <button class="db on" id="d3" onclick="setDelay(3)">3 seg</button>
      <button class="db" id="d5" onclick="setDelay(5)">5 seg</button>
      <button class="db" id="d10" onclick="setDelay(10)">10 seg</button>
      <button class="db" id="d30" onclick="setDelay(30)">30 seg</button>
    </div>
    <div class="delay-warn" id="dWarn">‚ö° Recomendado: 3-10 seg</div>
  </div>

  <div class="btn-row">
    <button class="btn btn-blue" id="btnLoad">‚ñ∂ Cargar Contactos</button>
    <button class="btn btn-grad" id="btnAll" disabled>‚ö° Enviar Todos Autom√°tico</button>
    <button class="btn btn-red" id="btnReset">‚Ü∫ Reiniciar</button>
  </div>

  <div class="empty-state" id="emptyState">
    <div class="ei">üìß</div>
    <div class="et">Sin contactos cargados</div>
    <div class="es">Ingres√° los contactos arriba y hac√© click en "Cargar Contactos"</div>
  </div>

  <div class="card" id="card">
    <div class="card-top">
      <div>
        <div class="cn" id="cName">‚Äî</div>
        <div class="ce" id="cEmail">‚Äî</div>
        <div class="ci" id="cIdx">‚Äî</div>
      </div>
      <div class="tag" id="cTag">PR√ìXIMO</div>
    </div>
    <div class="preview">
      <div class="ph">
        <div class="pf2">ASUNTO: <strong id="pSubject">‚Äî</strong></div>
        <div class="pf2">PARA: <strong id="pTo">‚Äî</strong></div>
      </div>
      <div class="pb2" id="pBody">‚Äî</div>
    </div>
    <div class="card-btns">
      <button class="btn btn-blue" id="btnOne">‚úâÔ∏è Enviar Este Email</button>
      <button class="btn btn-out" id="btnSkip">‚Üí Omitir</button>
    </div>
  </div>

  <div class="done-state" id="doneState">
    <div class="done-icon">‚úÖ</div>
    <div class="done-title">¬°Campa√±a completada!</div>
    <div class="done-sub" id="doneSub">‚Äî</div>
  </div>

  <div class="history-panel">
    <div class="panel-label">// Historial de env√≠os</div>
    <div class="history-list" id="histList">
      <div class="empty-history">Los env√≠os aparecer√°n aqu√≠</div>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var CLIENT_ID = '149070712813-djuli9g8d773l6op2i0nnnn4jjnshqkb.apps.googleusercontent.com';
var SCOPES = 'https://www.googleapis.com/auth/gmail.send';

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var contacts = [];
var idx = 0, sent = 0, omit = 0, errs = 0;
var hist = [];
var token = null;
var delay = 3;
var mode = 'auto';
var running = false;

// ‚îÄ‚îÄ DOM REFS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function $(id){ return document.getElementById(id); }

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.onload = function() {
  $('btnLoad').onclick = loadContacts;
  $('btnAll').onclick = sendAll;
  $('btnReset').onclick = resetAll;
  $('btnSkip').onclick = skipContact;
  $('btnOne').onclick = sendOne;
  $('btnCon').onclick = connectGmail;
  $('btnDis').onclick = disconnectGmail;
  $('modeA').onclick = function(){ setMode('auto'); };
  $('modeM').onclick = function(){ setMode('manual'); };
};

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function connectGmail() {
  if (!window.google) {
    alert('Error: la librer√≠a de Google no carg√≥. Verific√° tu conexi√≥n a internet y recarg√° la p√°gina.');
    return;
  }
  var client = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: function(resp) {
      if (resp.access_token) {
        token = resp.access_token;
        $('authDot').className = 'auth-dot on';
        $('authLabel').textContent = 'Gmail conectado ‚úì';
        $('authSub').textContent = 'Listo para enviar emails autom√°ticamente';
        $('btnCon').style.display = 'none';
        $('btnDis').style.display = 'inline-flex';
        updateAllBtn();
      }
    }
  });
  client.requestAccessToken();
}

function disconnectGmail() {
  if (token) { try { google.accounts.oauth2.revoke(token); } catch(e){} }
  token = null;
  $('authDot').className = 'auth-dot';
  $('authLabel').textContent = 'No conectado a Gmail';
  $('authSub').textContent = 'Autentic√° tu cuenta para enviar emails directamente';
  $('btnCon').style.display = 'inline-flex';
  $('btnDis').style.display = 'none';
  updateAllBtn();
}

// ‚îÄ‚îÄ MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setMode(m) {
  mode = m;
  $('modeA').className = 'mode-btn' + (m === 'auto' ? ' on' : '');
  $('modeM').className = 'mode-btn' + (m === 'manual' ? ' on' : '');
  $('delayBar').style.display = m === 'auto' ? 'flex' : 'none';
  updateAllBtn();
  if (contacts.length > 0) showCurrent();
}

function updateAllBtn() {
  $('btnAll').disabled = !(mode === 'auto' && token && contacts.length > 0 && !running);
}

// ‚îÄ‚îÄ DELAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setDelay(s) {
  delay = s;
  ['d0','d3','d5','d10','d30'].forEach(function(id) {
    var n = parseInt(id.replace('d',''));
    $(id).className = 'db' + (n === s ? ' on' : '');
  });
  $('dWarn').textContent = s === 0 ? '‚ö†Ô∏è Sin delay: mayor riesgo de spam' : s <= 5 ? '‚ö° Recomendado: 3-10 seg' : '‚úì Buena cadencia';
}

// ‚îÄ‚îÄ CONTACTOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseContacts(raw) {
  var result = [];
  var lines = raw.trim().split('\n');
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i].trim();
    if (!line) continue;
    var comma = line.indexOf(',');
    if (comma > 0) {
      var name = line.substring(0, comma).trim();
      var email = line.substring(comma + 1).trim();
      if (email.indexOf('@') > 0) {
        result.push({ name: name, email: email });
      }
    }
  }
  return result;
}

function loadContacts() {
  var raw = $('inContacts').value;
  if (!raw.trim()) { alert('Ingres√° al menos un contacto.'); return; }
  contacts = parseContacts(raw);
  if (contacts.length === 0) { alert('No se encontraron emails v√°lidos.\nFormato requerido: Nombre, email@dominio.com'); return; }
  idx = 0; sent = 0; omit = 0; errs = 0; hist = [];
  $('histList').innerHTML = '<div class="empty-history">Los env√≠os aparecer√°n aqu√≠</div>';
  updateAllBtn();
  showCurrent();
}

// ‚îÄ‚îÄ UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function msg(template, name) {
  return template.replace(/\{nombre\}/gi, name);
}

function showCurrent() {
  if (idx >= contacts.length) {
    $('card').className = 'card';
    $('doneState').style.display = 'block';
    $('doneSub').textContent = 'Enviados: ' + sent + ' | Omitidos: ' + omit + ' | Errores: ' + errs + ' | Total: ' + contacts.length;
    updateStats();
    return;
  }
  var c = contacts[idx];
  var subj = $('inSubject').value || 'AV MERCH';
  var body = msg($('inMessage').value, c.name);

  $('cName').textContent = c.name;
  $('cEmail').textContent = c.email;
  $('cIdx').textContent = 'Contacto ' + (idx + 1) + ' de ' + contacts.length;
  $('cTag').textContent = idx === 0 ? 'PRIMERO' : idx === contacts.length - 1 ? '√öLTIMO' : 'SIGUIENTE';
  $('pSubject').textContent = subj;
  $('pTo').textContent = c.email;
  $('pBody').textContent = body;

  if (mode === 'manual') {
    $('btnOne').textContent = '‚úâÔ∏è Abrir en Email';
    $('btnOne').onclick = sendOneManual;
  } else {
    $('btnOne').textContent = '‚úâÔ∏è Enviar Este Email';
    $('btnOne').onclick = sendOne;
    $('btnOne').disabled = !token;
  }

  $('card').className = 'card on';
  $('emptyState').style.display = 'none';
  $('doneState').style.display = 'none';
  updateStats();
}

function updateStats() {
  var total = contacts.length;
  var done = sent + omit + errs;
  $('sTotal').textContent = total;
  $('sEnv').textContent = sent;
  $('sOmi').textContent = omit;
  $('sErr').textContent = errs;
  var pct = total > 0 ? Math.round((done / total) * 100) : 0;
  $('pPct').textContent = pct + '%';
  $('pFill').style.width = pct + '%';
}

function addHist(name, email, status) {
  hist.unshift({ name: name, email: email, status: status });
  var html = '';
  for (var i = 0; i < hist.length; i++) {
    var h = hist[i];
    var label = h.status === 'sent' ? '‚úì enviado' : h.status === 'skipped' ? 'omitido' : '‚úó error';
    html += '<div class="hi"><div class="hd ' + h.status + '"></div><div class="hn">' + h.name + '</div><div class="hem">' + h.email + '</div><div class="hs ' + h.status + '">' + label + '</div></div>';
  }
  $('histList').innerHTML = html;
}

// ‚îÄ‚îÄ SEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function makeRaw(to, subject, body) {
  var nl = '\r\n';
  var encoded = '';
  try { encoded = btoa(unescape(encodeURIComponent(subject))); } catch(e) { encoded = btoa(subject); }
  var raw = 'To: ' + to + nl + 'Subject: =?utf-8?B?' + encoded + '?=' + nl + 'Content-Type: text/plain; charset=utf-8' + nl + nl + body;
  var b64 = '';
  try { b64 = btoa(unescape(encodeURIComponent(raw))); } catch(e) { b64 = btoa(raw); }
  return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

function sendEmailAPI(to, subject, body) {
  return fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/send', {
    method: 'POST',
    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
    body: JSON.stringify({ raw: makeRaw(to, subject, body) })
  }).then(function(r) {
    if (!r.ok) throw new Error('HTTP ' + r.status);
    return true;
  });
}

function sendOne() {
  if (!token) { alert('Primero conect√° tu cuenta de Gmail.'); return; }
  var c = contacts[idx];
  var subj = $('inSubject').value || 'AV MERCH';
  var body = msg($('inMessage').value, c.name);
  $('btnOne').disabled = true;
  sendEmailAPI(c.email, subj, body).then(function() {
    addHist(c.name, c.email, 'sent');
    sent++;
    idx++;
    $('btnOne').disabled = false;
    showCurrent();
  }).catch(function(e) {
    console.error(e);
    addHist(c.name, c.email, 'error');
    errs++;
    idx++;
    $('btnOne').disabled = false;
    showCurrent();
  });
}

function sendOneManual() {
  var c = contacts[idx];
  var subj = $('inSubject').value || 'AV MERCH';
  var body = msg($('inMessage').value, c.name);
  window.location.href = 'mailto:' + c.email + '?subject=' + encodeURIComponent(subj) + '&body=' + encodeURIComponent(body);
  addHist(c.name, c.email, 'sent');
  sent++; idx++;
  setTimeout(showCurrent, 500);
}

function sendAll() {
  if (!token) { alert('Primero conect√° tu cuenta de Gmail.'); return; }
  if (contacts.length === 0) { alert('Carg√° los contactos primero.'); return; }
  var remaining = contacts.length - idx;
  var mins = Math.ceil(remaining * delay / 60);
  if (!confirm('¬øEnviar emails a ' + remaining + ' contacto' + (remaining !== 1 ? 's' : '') + '?\n\nDelay: ' + delay + ' segundos entre cada email\nTiempo estimado: ~' + mins + ' minuto' + (mins !== 1 ? 's' : ''))) return;

  running = true;
  updateAllBtn();
  $('overlay').className = 'overlay on';
  var subj = $('inSubject').value || 'AV MERCH';

  function next() {
    if (idx >= contacts.length) {
      $('overlay').className = 'overlay';
      running = false;
      showCurrent();
      updateAllBtn();
      return;
    }
    var c = contacts[idx];
    var body = msg($('inMessage').value, c.name);
    $('overlayText').textContent = 'Enviando ' + (idx + 1) + '/' + contacts.length + ': ' + c.name + '...';

    sendEmailAPI(c.email, subj, body).then(function() {
      addHist(c.name, c.email, 'sent');
      sent++; idx++;
      updateStats();
      if (delay > 0 && idx < contacts.length) {
        var countdown = delay;
        var timer = setInterval(function() {
          $('overlayText').textContent = 'Pr√≥ximo en ' + countdown + 's... (' + (idx + 1) + '/' + contacts.length + ')';
          countdown--;
          if (countdown < 0) { clearInterval(timer); next(); }
        }, 1000);
      } else { next(); }
    }).catch(function(e) {
      console.error(e);
      addHist(c.name, c.email, 'error');
      errs++; idx++;
      updateStats();
      next();
    });
  }
  next();
}

function skipContact() {
  var c = contacts[idx];
  addHist(c.name, c.email, 'skipped');
  omit++; idx++;
  showCurrent();
}

function resetAll() {
  contacts = []; idx = 0; sent = 0; omit = 0; errs = 0; hist = [];
  running = false;
  $('card').className = 'card';
  $('doneState').style.display = 'none';
  $('emptyState').style.display = 'block';
  $('histList').innerHTML = '<div class="empty-history">Los env√≠os aparecer√°n aqu√≠</div>';
  updateStats();
  updateAllBtn();
}
</script>

<script src="https://accounts.google.com/gsi/client" async></script>
</body>
</html>

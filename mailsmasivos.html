<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AV MERCH ‚Äî Env√≠o Email Masivo</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #05080f; --surface: #0c1020; --border: #1a2040;
    --blue: #4285F4; --blue2: #5b9cf6; --white: #e8eaf0;
    --muted: #445; --accent: #a8d4ff; --danger: #ff5252;
    --yellow: #ffd54f; --green: #69f0ae;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--white); font-family:'Syne',sans-serif; min-height:100vh; }
  body::before {
    content:''; position:fixed; inset:0;
    background: radial-gradient(ellipse 80% 50% at 50% -10%, rgba(66,133,244,0.12), transparent);
    pointer-events:none; z-index:0;
  }
  .container { max-width:920px; margin:0 auto; padding:40px 24px; position:relative; z-index:1; }

  /* HEADER */
  header { margin-bottom:40px; }
  .logo-row { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
  .logo { background:var(--blue); color:#fff; font-weight:800; font-size:12px; padding:5px 12px; letter-spacing:2px; }
  .g-badge { background:#0d1530; border:1px solid var(--blue); color:var(--blue2); font-family:'DM Mono',monospace; font-size:11px; padding:4px 10px; }
  h1 { font-size:clamp(26px,5vw,44px); font-weight:800; letter-spacing:-1.5px; line-height:1; }
  h1 span { color:var(--blue2); }
  .subtitle { font-family:'DM Mono',monospace; font-size:11px; color:var(--muted); margin-top:6px; letter-spacing:1px; }

  /* AUTH BANNER */
  .auth-banner {
    background:var(--surface); border:1px solid var(--border);
    padding:20px 24px; margin-bottom:14px;
    display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;
  }
  .auth-info { display:flex; align-items:center; gap:12px; }
  .auth-dot { width:8px; height:8px; border-radius:50%; background:var(--muted); flex-shrink:0; }
  .auth-dot.connected { background:var(--green); box-shadow:0 0 8px var(--green); }
  .auth-text { font-family:'DM Mono',monospace; font-size:12px; }
  .auth-text strong { color:var(--white); }
  .auth-text span { color:var(--muted); display:block; font-size:10px; margin-top:2px; }

  /* PANELS */
  .grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:14px; }
  @media(max-width:640px){ .grid{ grid-template-columns:1fr; } }

  .panel { background:var(--surface); border:1px solid var(--border); padding:22px; position:relative; }
  .panel::before { content:''; position:absolute; top:0; left:0; width:3px; height:100%; background:var(--blue); }
  .panel-label { font-family:'DM Mono',monospace; font-size:10px; color:var(--blue2); letter-spacing:2px; text-transform:uppercase; margin-bottom:12px; }

  textarea, input[type="text"], input[type="email"] {
    width:100%; background:#070d1e; border:1px solid var(--border);
    color:var(--white); font-family:'DM Mono',monospace; font-size:13px;
    padding:12px; resize:vertical; outline:none; transition:border-color 0.2s; line-height:1.6;
  }
  textarea:focus, input:focus { border-color:var(--blue); }
  textarea { min-height:120px; }
  input[type="text"], input[type="email"] { resize:none; }

  .field-label { font-family:'DM Mono',monospace; font-size:10px; color:var(--muted); letter-spacing:1px; margin-bottom:6px; margin-top:14px; }
  .field-label:first-of-type { margin-top:0; }

  .hint { font-family:'DM Mono',monospace; font-size:10px; color:var(--muted); margin-top:8px; line-height:1.7; }
  .hint strong { color:var(--accent); }

  /* STATS */
  .stats-bar { display:flex; align-items:center; background:var(--surface); border:1px solid var(--border); margin-bottom:14px; }
  .stat { padding:16px 20px; border-right:1px solid var(--border); text-align:center; }
  .stat-num { font-size:28px; font-weight:800; color:var(--accent); line-height:1; }
  .stat-label { font-family:'DM Mono',monospace; font-size:10px; color:var(--muted); letter-spacing:1px; margin-top:2px; }
  .progress-wrap { flex:1; padding:16px 24px; }
  .progress-label { font-family:'DM Mono',monospace; font-size:10px; color:var(--muted); margin-bottom:8px; display:flex; justify-content:space-between; }
  .progress-bar { background:#0d1530; height:6px; }
  .progress-fill { height:100%; background:var(--blue); transition:width 0.5s ease; width:0%; }

  /* DELAY */
  .delay-bar {
    background:var(--surface); border:1px solid var(--border);
    padding:14px 22px; margin-bottom:14px;
    display:flex; align-items:center; gap:16px; flex-wrap:wrap;
  }
  .delay-label { font-family:'DM Mono',monospace; font-size:11px; color:var(--muted); flex-shrink:0; }
  .delay-opts { display:flex; gap:8px; flex-wrap:wrap; }
  .delay-btn {
    font-family:'DM Mono',monospace; font-size:11px;
    padding:5px 12px; background:transparent; border:1px solid var(--border);
    color:var(--muted); cursor:pointer; transition:all 0.15s;
  }
  .delay-btn.active { border-color:var(--blue); color:var(--blue2); background:#0d1530; }
  .delay-warn { font-family:'DM Mono',monospace; font-size:10px; color:var(--yellow); margin-left:auto; }

  /* QUEUE CARD */
  .queue-card { background:var(--surface); border:1px solid var(--border); padding:24px; margin-bottom:14px; display:none; }
  .queue-card.active { display:block; }
  .qc-top { display:flex; align-items:flex-start; justify-content:space-between; gap:16px; flex-wrap:wrap; margin-bottom:16px; }
  .qc-name { font-size:20px; font-weight:800; }
  .qc-email { font-family:'DM Mono',monospace; font-size:13px; color:var(--blue2); margin-top:3px; }
  .qc-index { font-family:'DM Mono',monospace; font-size:11px; color:var(--muted); margin-top:4px; }
  .tag { display:inline-block; background:#0d1530; color:var(--blue2); font-family:'DM Mono',monospace; font-size:10px; padding:3px 10px; letter-spacing:1px; border:1px solid var(--border); }
  .preview-section { border:1px solid var(--border); overflow:hidden; }
  .preview-header { background:#0d1530; padding:10px 14px; font-family:'DM Mono',monospace; font-size:11px; display:flex; gap:20px; }
  .preview-field { color:var(--muted); }
  .preview-field strong { color:var(--white); }
  .preview-body { padding:14px; font-family:'DM Mono',monospace; font-size:12px; line-height:1.8; color:#b0bcd0; white-space:pre-wrap; word-break:break-word; max-height:130px; overflow-y:auto; }

  /* PROGRESS SENDING */
  .sending-overlay {
    display:none; position:fixed; inset:0; background:rgba(5,8,15,0.85);
    align-items:center; justify-content:center; z-index:100; flex-direction:column; gap:16px;
  }
  .sending-overlay.active { display:flex; }
  .sending-spinner { width:48px; height:48px; border:3px solid var(--border); border-top-color:var(--blue); border-radius:50%; animation:spin 0.8s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }
  .sending-text { font-family:'DM Mono',monospace; font-size:13px; color:var(--blue2); }

  /* BUTTONS */
  .btn-row { display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; }
  .btn { display:inline-flex; align-items:center; gap:8px; font-family:'Syne',sans-serif; font-size:13px; font-weight:700; padding:12px 22px; cursor:pointer; border:none; letter-spacing:0.5px; transition:all 0.15s; text-decoration:none; }
  .btn-primary { background:var(--blue); color:#fff; }
  .btn-primary:hover { background:#5b9cf6; transform:translateY(-1px); }
  .btn-primary:disabled { opacity:0.3; cursor:not-allowed; transform:none; }
  .btn-send-all { background:linear-gradient(135deg, var(--blue), #7c4dff); color:#fff; }
  .btn-send-all:hover { transform:translateY(-1px); filter:brightness(1.1); }
  .btn-send-all:disabled { opacity:0.3; cursor:not-allowed; transform:none; filter:none; }
  .btn-skip { background:transparent; border:1px solid var(--border); color:var(--muted); }
  .btn-skip:hover { border-color:var(--white); color:var(--white); }
  .btn-load { background:transparent; border:1px solid var(--blue); color:var(--blue2); }
  .btn-load:hover { background:var(--blue); color:#fff; }
  .btn-restart { background:transparent; border:1px solid var(--muted); color:var(--muted); }
  .btn-restart:hover { border-color:var(--danger); color:var(--danger); }
  .btn-connect { background:var(--blue); color:#fff; font-size:13px; font-weight:700; padding:10px 20px; font-family:'Syne',sans-serif; cursor:pointer; border:none; letter-spacing:0.5px; transition:all 0.15s; }
  .btn-connect:hover { background:#5b9cf6; }
  .btn-disconnect { background:transparent; border:1px solid var(--danger); color:var(--danger); font-size:12px; font-weight:700; padding:8px 14px; font-family:'Syne',sans-serif; cursor:pointer; letter-spacing:0.5px; transition:all 0.15s; }
  .btn-disconnect:hover { background:var(--danger); color:#fff; }

  /* EMPTY / DONE */
  .empty-state { text-align:center; padding:50px 20px; border:1px dashed var(--border); margin-bottom:14px; }
  .empty-icon { font-size:44px; margin-bottom:14px; opacity:0.4; }
  .empty-title { font-size:18px; font-weight:700; color:var(--muted); margin-bottom:8px; }
  .empty-sub { font-family:'DM Mono',monospace; font-size:11px; color:var(--muted); }

  .done-state { text-align:center; padding:50px 20px; background:var(--surface); border:1px solid var(--green); margin-bottom:14px; display:none; }
  .done-icon { font-size:50px; margin-bottom:12px; }
  .done-title { font-size:24px; font-weight:800; color:var(--green); margin-bottom:6px; }
  .done-sub { font-family:'DM Mono',monospace; font-size:12px; color:var(--muted); }

  /* HISTORY */
  .history-panel { background:var(--surface); border:1px solid var(--border); padding:22px; }
  .history-list { max-height:200px; overflow-y:auto; }
  .history-item { display:flex; align-items:center; gap:12px; padding:8px 0; border-bottom:1px solid #0d1530; font-family:'DM Mono',monospace; font-size:11px; }
  .history-item:last-child { border-bottom:none; }
  .h-dot { width:6px; height:6px; border-radius:50%; background:var(--blue2); flex-shrink:0; }
  .h-dot.skipped { background:var(--muted); }
  .h-dot.error { background:var(--danger); }
  .h-name { color:var(--white); flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .h-email { color:var(--muted); min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:200px; }
  .h-status { flex-shrink:0; }
  .h-status.sent { color:var(--green); }
  .h-status.skipped { color:var(--muted); }
  .h-status.error { color:var(--danger); }
  .empty-history { font-family:'DM Mono',monospace; font-size:11px; color:var(--muted); text-align:center; padding:20px; }

  ::-webkit-scrollbar { width:4px; }
  ::-webkit-scrollbar-track { background:#070d1e; }
  ::-webkit-scrollbar-thumb { background:var(--border); }

  .notice {
    background:#0a0f20; border:1px solid #1a2a50; border-left:3px solid var(--yellow);
    padding:12px 16px; font-family:'DM Mono',monospace; font-size:11px; color:#b0b8c8;
    margin-bottom:14px; line-height:1.7;
  }
  .notice strong { color:var(--yellow); }

  /* MODO MANUAL */
  .mode-bar { display:flex; gap:0; margin-bottom:14px; background:var(--surface); border:1px solid var(--border); overflow:hidden; }
  .mode-btn { flex:1; padding:12px; font-family:'DM Mono',monospace; font-size:11px; letter-spacing:1px; background:transparent; border:none; color:var(--muted); cursor:pointer; transition:all 0.15s; text-align:center; }
  .mode-btn.active { background:var(--blue); color:#fff; }
  .mode-btn:not(.active):hover { background:#0d1530; color:var(--white); }
</style>
</head>
<body>

<div class="sending-overlay" id="sendingOverlay">
  <div class="sending-spinner"></div>
  <div class="sending-text" id="sendingText">Enviando...</div>
</div>

<div class="container">

  <header>
    <div class="logo-row">
      <div class="logo">AV MERCH</div>
      <div class="g-badge">Gmail API</div>
    </div>
    <h1>Env√≠o <span>Email</span><br>Masivo</h1>
    <div class="subtitle">// autentic√° tu Gmail ‚Üí carg√° contactos ‚Üí envi√° autom√°tico con delay</div>
  </header>

  <!-- NOTICE -->
  <div class="notice">
    <strong>‚ÑπÔ∏è L√≠mites recomendados:</strong> Gmail permite ~500 emails/d√≠a en cuentas normales y hasta 2.000 en Google Workspace.
    Recomendamos usar delay entre env√≠os para evitar ser marcado como spam. Los contactos aqu√≠ son personas que te dieron su mail.
  </div>

  <!-- AUTH -->
  <div class="auth-banner" id="authBanner">
    <div class="auth-info">
      <div class="auth-dot" id="authDot"></div>
      <div class="auth-text">
        <strong id="authLabel">No conectado a Gmail</strong>
        <span id="authEmail">Autentic√° tu cuenta para enviar emails directamente</span>
      </div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <button class="btn-connect" id="btnConnect" onclick="connectGmail()">Conectar Gmail</button>
      <button class="btn-disconnect" id="btnDisconnect" onclick="disconnectGmail()" style="display:none">Desconectar</button>
    </div>
  </div>

  <!-- MODO -->
  <div class="mode-bar">
    <button class="mode-btn active" id="modeAuto" onclick="setMode('auto')">‚ö° AUTOM√ÅTICO (Gmail API)</button>
    <button class="mode-btn" id="modeManual" onclick="setMode('manual')">‚úâÔ∏è MANUAL (mailto:)</button>
  </div>

  <!-- STATS -->
  <div class="stats-bar">
    <div class="stat"><div class="stat-num" id="statTotal">0</div><div class="stat-label">TOTAL</div></div>
    <div class="stat"><div class="stat-num" id="statEnviados" style="color:var(--green)">0</div><div class="stat-label">ENVIADOS</div></div>
    <div class="stat"><div class="stat-num" id="statOmitidos" style="color:var(--muted)">0</div><div class="stat-label">OMITIDOS</div></div>
    <div class="stat"><div class="stat-num" id="statErrores" style="color:var(--danger)">0</div><div class="stat-label">ERRORES</div></div>
    <div class="progress-wrap">
      <div class="progress-label"><span>PROGRESO</span><span id="progressPct">0%</span></div>
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    </div>
  </div>

  <!-- INPUTS -->
  <div class="grid">
    <div class="panel">
      <div class="panel-label">// 01 ‚Äî Contactos</div>
      <textarea id="contactsInput" placeholder="Nombre, Email&#10;Juan P√©rez, juan@empresa.com&#10;Mar√≠a L√≥pez, maria@negocio.com&#10;Carlos Soto, carlos@gmail.com&#10;&#10;‚Äî un contacto por l√≠nea&#10;‚Äî formato: Nombre, Email"></textarea>
      <div class="hint">
        ‚ú¶ Un contacto por l√≠nea: <strong>Nombre, <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="7a1f171b13163a1e15171314131554191517">[email&#160;protected]</a></strong><br>
        ‚ú¶ Pod√©s copiar y pegar desde Excel directamente<br>
        ‚ú¶ Se ignoran l√≠neas con formato inv√°lido
      </div>
    </div>
    <div class="panel">
      <div class="panel-label">// 02 ‚Äî Asunto y Mensaje</div>
      <div class="field-label">ASUNTO</div>
      <input type="text" id="subjectInput" placeholder="Uniformes corporativos a medida ‚Äî AV MERCH">
      <div class="field-label" style="margin-top:12px;">CUERPO DEL EMAIL</div>
      <textarea id="messageInput" placeholder="Hola {nombre},&#10;&#10;Mi nombre es Fabrizio y te escribo de AV MERCH, empresa especializada en uniformes corporativos a medida para empresas de todos los rubros.&#10;&#10;Me gustar√≠a contarte sobre nuestras propuestas. ¬øTen√©s disponibilidad para una breve charla?&#10;&#10;Saludos,&#10;Fabrizio&#10;AV MERCH" style="min-height:110px;"></textarea>
      <div class="hint">
        ‚ú¶ Us√° <strong>{nombre}</strong> para personalizar el saludo<br>
        ‚ú¶ El mensaje se env√≠a tal como lo escrib√≠s<br>
        ‚ú¶ Los saltos de l√≠nea se respetan en el email
      </div>
    </div>
  </div>

  <!-- DELAY -->
  <div class="delay-bar" id="delayBar">
    <div class="delay-label">DELAY ENTRE ENV√çOS:</div>
    <div class="delay-opts">
      <button class="delay-btn" onclick="setDelay(0)" id="d0">Sin delay</button>
      <button class="delay-btn active" onclick="setDelay(3)" id="d3">3 seg</button>
      <button class="delay-btn" onclick="setDelay(5)" id="d5">5 seg</button>
      <button class="delay-btn" onclick="setDelay(10)" id="d10">10 seg</button>
      <button class="delay-btn" onclick="setDelay(30)" id="d30">30 seg</button>
    </div>
    <div class="delay-warn" id="delayWarn">‚ö° Recomendado: 3-10 seg para evitar spam</div>
  </div>

  <div style="display:flex; gap:10px; margin-bottom:14px; flex-wrap:wrap;">
    <button class="btn btn-load" onclick="loadContacts()">‚ñ∂ Cargar Contactos</button>
    <button class="btn btn-send-all" id="btnSendAll" onclick="startSendAll()" disabled>‚ö° Enviar Todos Autom√°tico</button>
    <button class="btn btn-restart" onclick="resetAll()">‚Ü∫ Reiniciar</button>
  </div>

  <!-- EMPTY -->
  <div class="empty-state" id="emptyState">
    <div class="empty-icon">üìß</div>
    <div class="empty-title">Sin contactos cargados</div>
    <div class="empty-sub">Ingres√° contactos arriba y hac√© click en "Cargar Contactos"</div>
  </div>

  <!-- QUEUE CARD -->
  <div class="queue-card" id="queueCard">
    <div class="qc-top">
      <div>
        <div class="qc-name" id="qcName">‚Äî</div>
        <div class="qc-email" id="qcEmail">‚Äî</div>
        <div class="qc-index" id="qcIndex">‚Äî</div>
      </div>
      <div class="tag" id="qcTag">PR√ìXIMO</div>
    </div>
    <div class="preview-section">
      <div class="preview-header">
        <div class="preview-field">ASUNTO: <strong id="previewSubject">‚Äî</strong></div>
        <div class="preview-field">PARA: <strong id="previewTo">‚Äî</strong></div>
      </div>
      <div class="preview-body" id="previewBody">‚Äî</div>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" id="btnSendOne" onclick="sendOne()">‚úâÔ∏è Enviar Este Email</button>
      <button class="btn btn-skip" onclick="skipContact()">‚Üí Omitir</button>
    </div>
  </div>

  <!-- DONE -->
  <div class="done-state" id="doneState">
    <div class="done-icon">‚úÖ</div>
    <div class="done-title">¬°Campa√±a completada!</div>
    <div class="done-sub" id="doneSub">‚Äî</div>
  </div>

  <!-- HISTORY -->
  <div class="history-panel">
    <div class="panel-label">// Historial de env√≠os</div>
    <div class="history-list" id="historyList">
      <div class="empty-history">Los env√≠os aparecer√°n aqu√≠</div>
    </div>
  </div>

</div>

<!-- Google API -->
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURACI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORTANTE: Para usar el modo autom√°tico necesit√°s:
// 1. Crear un proyecto en console.cloud.google.com
// 2. Habilitar Gmail API
// 3. Crear credenciales OAuth 2.0 (tipo "Web application")
// 4. Poner el Client ID abajo
// 5. En "Authorized JavaScript origins" poner la URL donde abr√≠s este archivo

const CLIENT_ID = '149070712813-djuli9g8d773l6op2i0nnnn4jjnshqkb.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/gmail.send';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESTADO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let contacts = [], currentIndex = 0, sentCount = 0, skippedCount = 0, errorCount = 0;
let history = [], accessToken = null, delaySeconds = 3, mode = 'auto', sending = false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GMAIL AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function connectGmail() {
  if (CLIENT_ID === 'TU_CLIENT_ID_DE_GOOGLE_AQUI') {
    alert('‚ö†Ô∏è Necesit√°s configurar el CLIENT_ID de Google.\n\nInstrucciones:\n1. Abr√≠ console.cloud.google.com\n2. Cre√° un proyecto nuevo\n3. Habilit√° "Gmail API"\n4. Cre√° credenciales OAuth 2.0\n5. Copi√° el Client ID y pegalo en el c√≥digo (l√≠nea ~148)\n\nO us√° el modo MANUAL (mailto:) que no requiere configuraci√≥n.');
    return;
  }
  const client = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: (response) => {
      if (response.access_token) {
        accessToken = response.access_token;
        setConnected(true);
      }
    }
  });
  client.requestAccessToken();
}

function disconnectGmail() {
  if (accessToken) google.accounts.oauth2.revoke(accessToken, () => {});
  accessToken = null;
  setConnected(false);
}

function setConnected(ok) {
  document.getElementById('authDot').className = 'auth-dot' + (ok ? ' connected' : '');
  document.getElementById('authLabel').textContent = ok ? 'Gmail conectado' : 'No conectado a Gmail';
  document.getElementById('authEmail').textContent = ok ? 'Listo para enviar emails autom√°ticamente' : 'Autentic√° tu cuenta para enviar emails directamente';
  document.getElementById('btnConnect').style.display = ok ? 'none' : 'block';
  document.getElementById('btnDisconnect').style.display = ok ? 'block' : 'none';
  updateSendAllBtn();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setMode(m) {
  mode = m;
  document.getElementById('modeAuto').className = 'mode-btn' + (m === 'auto' ? ' active' : '');
  document.getElementById('modeManual').className = 'mode-btn' + (m === 'manual' ? ' active' : '');
  document.getElementById('delayBar').style.display = m === 'auto' ? 'flex' : 'none';
  updateSendAllBtn();
  if (contacts.length > 0) showCurrent();
}

function updateSendAllBtn() {
  const btn = document.getElementById('btnSendAll');
  btn.disabled = !(mode === 'auto' && accessToken && contacts.length > 0 && !sending);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DELAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setDelay(s) {
  delaySeconds = s;
  ['d0','d3','d5','d10','d30'].forEach(id => {
    document.getElementById(id).className = 'delay-btn' + (parseInt(id.replace('d','')) === s ? ' active' : '');
  });
  document.getElementById('delayWarn').textContent =
    s === 0 ? '‚ö†Ô∏è Sin delay: mayor riesgo de ser marcado como spam' :
    s <= 5 ? '‚ö° Recomendado: 3-10 seg para evitar spam' :
    '‚úì Buena cadencia para evitar filtros de spam';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTACTOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parseContacts(raw) {
  return raw.trim().split('\n').map(l => l.trim()).filter(l => l.length > 0).map(line => {
    const parts = line.split(',');
    if (parts.length >= 2) {
      const name = parts[0].trim();
      const email = parts.slice(1).join(',').trim();
      if (email.includes('@')) return { name, email };
    }
    return null;
  }).filter(Boolean);
}

function loadContacts() {
  const raw = document.getElementById('contactsInput').value;
  if (!raw.trim()) { alert('Ingres√° al menos un contacto.'); return; }
  contacts = parseContacts(raw);
  if (contacts.length === 0) { alert('No se encontraron emails v√°lidos. Revis√° el formato: Nombre, email@dominio.com'); return; }
  currentIndex = 0; sentCount = 0; skippedCount = 0; errorCount = 0; history = [];
  document.getElementById('historyList').innerHTML = '<div class="empty-history">Los env√≠os aparecer√°n aqu√≠</div>';
  updateSendAllBtn();
  showCurrent();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildMessage(template, name) { return template.replace(/\{nombre\}/gi, name); }

function showCurrent() {
  if (currentIndex >= contacts.length) {
    document.getElementById('queueCard').classList.remove('active');
    document.getElementById('doneState').style.display = 'block';
    document.getElementById('doneSub').textContent = `Enviados: ${sentCount} | Omitidos: ${skippedCount} | Errores: ${errorCount} | Total: ${contacts.length}`;
    updateStats(); return;
  }
  const c = contacts[currentIndex];
  const subject = document.getElementById('subjectInput').value || 'AV MERCH';
  const body = buildMessage(document.getElementById('messageInput').value, c.name);

  document.getElementById('qcName').textContent = c.name;
  document.getElementById('qcEmail').textContent = c.email;
  document.getElementById('qcIndex').textContent = `Contacto ${currentIndex + 1} de ${contacts.length}`;
  document.getElementById('qcTag').textContent = currentIndex === 0 ? 'PRIMERO' : currentIndex === contacts.length - 1 ? '√öLTIMO' : 'SIGUIENTE';
  document.getElementById('previewSubject').textContent = subject;
  document.getElementById('previewTo').textContent = c.email;
  document.getElementById('previewBody').textContent = body;

  if (mode === 'manual') {
    document.getElementById('btnSendOne').textContent = '‚úâÔ∏è Abrir en Cliente de Email';
    document.getElementById('btnSendOne').onclick = sendOneManual;
  } else {
    document.getElementById('btnSendOne').textContent = '‚úâÔ∏è Enviar Este Email';
    document.getElementById('btnSendOne').onclick = sendOne;
    document.getElementById('btnSendOne').disabled = !accessToken;
  }

  document.getElementById('queueCard').classList.add('active');
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('doneState').style.display = 'none';
  updateStats();
}

function updateStats() {
  const total = contacts.length, processed = sentCount + skippedCount + errorCount;
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statEnviados').textContent = sentCount;
  document.getElementById('statOmitidos').textContent = skippedCount;
  document.getElementById('statErrores').textContent = errorCount;
  const pct = total > 0 ? Math.round((processed / total) * 100) : 0;
  document.getElementById('progressPct').textContent = pct + '%';
  document.getElementById('progressFill').style.width = pct + '%';
}

function addHistory(name, email, status) {
  history.unshift({ name, email, status });
  const list = document.getElementById('historyList');
  list.innerHTML = history.map(h => `
    <div class="history-item">
      <div class="h-dot ${h.status}"></div>
      <div class="h-name">${h.name}</div>
      <div class="h-email">${h.email}</div>
      <div class="h-status ${h.status}">${h.status === 'sent' ? '‚úì enviado' : h.status === 'skipped' ? 'omitido' : '‚úó error'}</div>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ENV√çO GMAIL API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function makeEmail(to, subject, body) {
  const nl = '\r\n';
  const raw = `To: ${to}${nl}Subject: =?utf-8?B?${btoa(unescape(encodeURIComponent(subject)))}?=${nl}Content-Type: text/plain; charset=utf-8${nl}${nl}${body}`;
  return btoa(unescape(encodeURIComponent(raw))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

async function sendEmailAPI(to, subject, body) {
  const raw = makeEmail(to, subject, body);
  const res = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/send', {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({ raw })
  });
  if (!res.ok) throw new Error(`Error ${res.status}: ${await res.text()}`);
  return true;
}

async function sendOne() {
  if (!accessToken) { alert('Primero conect√° tu cuenta de Gmail.'); return; }
  const c = contacts[currentIndex];
  const subject = document.getElementById('subjectInput').value || 'AV MERCH';
  const body = buildMessage(document.getElementById('messageInput').value, c.name);
  document.getElementById('btnSendOne').disabled = true;
  try {
    await sendEmailAPI(c.email, subject, body);
    addHistory(c.name, c.email, 'sent');
    sentCount++;
  } catch(e) {
    addHistory(c.name, c.email, 'error');
    errorCount++;
    console.error(e);
  }
  currentIndex++;
  document.getElementById('btnSendOne').disabled = false;
  showCurrent();
}

function sendOneManual() {
  const c = contacts[currentIndex];
  const subject = document.getElementById('subjectInput').value || 'AV MERCH';
  const body = buildMessage(document.getElementById('messageInput').value, c.name);
  window.location.href = `mailto:${c.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  addHistory(c.name, c.email, 'sent');
  sentCount++;
  currentIndex++;
  setTimeout(showCurrent, 500);
}

// ENV√çO MASIVO AUTOM√ÅTICO
async function startSendAll() {
  if (!accessToken) { alert('Primero conect√° tu cuenta de Gmail.'); return; }
  if (contacts.length === 0) { alert('Carg√° los contactos primero.'); return; }
  const remaining = contacts.length - currentIndex;
  if (!confirm(`¬øEnvi√°s emails a ${remaining} contacto${remaining !== 1 ? 's' : ''}?\n\nDelay configurado: ${delaySeconds} segundos entre cada email.\nTiempo estimado: ~${Math.ceil(remaining * delaySeconds / 60)} minutos.`)) return;

  sending = true;
  updateSendAllBtn();
  const overlay = document.getElementById('sendingOverlay');
  overlay.classList.add('active');

  const subject = document.getElementById('subjectInput').value || 'AV MERCH';

  while (currentIndex < contacts.length) {
    const c = contacts[currentIndex];
    const body = buildMessage(document.getElementById('messageInput').value, c.name);
    document.getElementById('sendingText').textContent = `Enviando ${currentIndex + 1}/${contacts.length}: ${c.name}...`;
    try {
      await sendEmailAPI(c.email, subject, body);
      addHistory(c.name, c.email, 'sent');
      sentCount++;
    } catch(e) {
      addHistory(c.name, c.email, 'error');
      errorCount++;
      console.error(e);
    }
    currentIndex++;
    updateStats();
    if (currentIndex < contacts.length && delaySeconds > 0) {
      for (let i = delaySeconds; i > 0; i--) {
        document.getElementById('sendingText').textContent = `Pr√≥ximo en ${i}s... (${currentIndex + 1}/${contacts.length})`;
        await new Promise(r => setTimeout(r, 1000));
      }
    }
  }

  overlay.classList.remove('active');
  sending = false;
  showCurrent();
  updateSendAllBtn();
}

function skipContact() {
  const c = contacts[currentIndex];
  addHistory(c.name, c.email, 'skipped');
  skippedCount++; currentIndex++;
  showCurrent();
}

function resetAll() {
  contacts = []; currentIndex = 0; sentCount = 0; skippedCount = 0; errorCount = 0; history = [];
  sending = false;
  document.getElementById('queueCard').classList.remove('active');
  document.getElementById('doneState').style.display = 'none';
  document.getElement